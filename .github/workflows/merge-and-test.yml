name: merge-and-test

on:
  workflow_run:
    workflows: ["security-check"]
    types: [completed]
    branches: [dev]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  check-security-status:
    name: Check Security Status
    runs-on: ubuntu-latest
    outputs:
      vulnerable: ${{ steps.check.outputs.vulnerable }}
    steps:
      - name: Download security scan result
        uses: actions/download-artifact@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
          name: security-scan-result
        continue-on-error: true

      - name: Check result
        id: check
        run: |
          if [ -f result.json ]; then
            VULN=$(jq -r '.summary.vulnerable_found' result.json)
            echo "vulnerable=$VULN" >> $GITHUB_OUTPUT
          else
            echo "vulnerable=false" >> $GITHUB_OUTPUT
          fi

  merge-to-test:
    name: Merge to test
    runs-on: ubuntu-latest
    needs: check-security-status
    if: needs.check-security-status.outputs.vulnerable == 'false'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get PR information
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              base: 'test',
              head: `${context.repo.owner}:dev`
            });
            
            if (prs.data.length > 0) {
              console.log(`Found PR #${prs.data[0].number}`);
              core.setOutput('pr_number', prs.data[0].number);
              core.setOutput('found', 'true');
            } else {
              console.log('No open PR found from dev to test');
              core.setOutput('found', 'false');
            }

      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Merge dev to test
        if: steps.pr.outputs.found == 'true'
        run: |
          git fetch origin dev test
          git checkout test
          git merge origin/dev --no-ff -m "Merge dev to test (CI/CD): Security check passed"
          git push origin test

      - name: Merge PR
        if: steps.pr.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: parseInt('${{ steps.pr.outputs.pr_number }}'),
              merge_method: 'squash'
            });
            
            console.log('✅ PR merged successfully');

      - name: Telegram notification - Merge success
        if: steps.pr.outputs.found == 'true'
        run: |
          if [ -z "${{ secrets.TELEGRAM_TOKEN }}" ] || [ -z "${{ secrets.TELEGRAM_CHAT_ID }}" ]; then
            echo "⏭️ Telegram secrets not configured. Skipping notification."
            exit 0
          fi
          
          MESSAGE="✅ Etapa 2: Código mergeado a rama test%0AURL: https://github.com/${{ github.repository }}/tree/test"
          
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d text="${MESSAGE}" \
          -d parse_mode="HTML"

  run-tests:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: merge-to-test
    steps:
      - name: Checkout test branch
        uses: actions/checkout@v4
        with:
          ref: test
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install dependencies
        run: |
          cd proyect
          npm install

      - name: Run linter
        continue-on-error: true
        run: |
          cd proyect
          npm run lint

      - name: Run tests (Jest)
        id: tests
        continue-on-error: true
        run: |
          cd proyect
          npm test -- --coverage --passWithNoTests 2>&1 | tee test-output.log
          echo "exit_code=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: proyect/test-output.log

      - name: Comment test results on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let testOutput = "No test output available";
            if (fs.existsSync('proyect/test-output.log')) {
              testOutput = fs.readFileSync('proyect/test-output.log', 'utf8');
            }
            
            const testSuccess = '${{ steps.tests.outputs.exit_code }}' === '0';
            
            const body = [
              testSuccess ? "✅ **Tests:** All tests passed!" : "❌ **Tests:** Some tests failed",
              "",
              "```",
              testOutput.substring(0, 1000),
              "```"
            ].join("\n");
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body
            });

      - name: Fail if tests failed
        if: steps.tests.outputs.exit_code != '0'
        run: |
          echo "❌ Tests failed!"
          exit 1

      - name: Telegram notification - Tests success
        if: success()
        run: |
          if [ -z "${{ secrets.TELEGRAM_TOKEN }}" ] || [ -z "${{ secrets.TELEGRAM_CHAT_ID }}" ]; then
            echo "⏭️ Telegram secrets not configured. Skipping notification."
            exit 0
          fi
          
          MESSAGE="✅ Etapa 2: Pruebas unitarias PASADAS%0AURL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d text="${MESSAGE}" \
          -d parse_mode="HTML"

      - name: Telegram notification - Tests failed
        if: failure()
        run: |
          if [ -z "${{ secrets.TELEGRAM_TOKEN }}" ] || [ -z "${{ secrets.TELEGRAM_CHAT_ID }}" ]; then
            echo "⏭️ Telegram secrets not configured. Skipping notification."
            exit 0
          fi
          
          MESSAGE="❌ Etapa 2: Pruebas unitarias FALLIDAS%0AURL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d text="${MESSAGE}" \
          -d parse_mode="HTML"

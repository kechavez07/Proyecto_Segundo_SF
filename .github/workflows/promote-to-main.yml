name: promote-to-main

on:
  push:
    branches:
      - test

permissions:
  contents: write

jobs:
  promote-to-main:
    name: Promote to main
    runs-on: ubuntu-latest
    steps:
      - name: Checkout test branch
        uses: actions/checkout@v4
        with:
          ref: test
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Pull Request to main
        id: create_pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            
            // Verificar si ya existe un PR abierto de test a main
            const { data: existingPRs } = await github.rest.pulls.list({
              owner,
              repo,
              state: 'open',
              head: `${owner}:test`,
              base: 'main'
            });
            
            if (existingPRs.length > 0) {
              console.log(`‚úì PR already exists: #${existingPRs[0].number}`);
              core.setOutput('pr_number', existingPRs[0].number);
              core.setOutput('pr_url', existingPRs[0].html_url);
              
              // Auto-merge existing PR
              try {
                await github.rest.pulls.merge({
                  owner,
                  repo,
                  pull_number: existingPRs[0].number,
                  merge_method: 'squash'
                });
                console.log('‚úì PR auto-merged');
                core.setOutput('merged', 'true');
              } catch (e) {
                console.log('Merge failed:', e.message);
                core.setOutput('merged', 'false');
              }
              return;
            }
            
            // Crear nuevo PR
            const { data: pr } = await github.rest.pulls.create({
              owner,
              repo,
              title: 'üöÄ Tests Passed - Ready for Production',
              head: 'test',
              base: 'main',
              body: [
                '## ‚úÖ All Tests Passed',
                '',
                'All automated tests have passed successfully.',
                '',
                '**Ready for production deployment**',
                '',
                `**Commit:** ${context.sha}`
              ].join('\n')
            });
            
            console.log(`‚úì Created PR #${pr.number}: ${pr.html_url}`);
            core.setOutput('pr_number', pr.number);
            core.setOutput('pr_url', pr.html_url);
            
            // Auto-merge immediately
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            try {
              await github.rest.pulls.merge({
                owner,
                repo,
                pull_number: pr.number,
                merge_method: 'squash'
              });
              console.log('‚úì PR auto-merged');
              core.setOutput('merged', 'true');
            } catch (e) {
              console.log('Merge failed:', e.message);
              core.setOutput('merged', 'false');
            }

      - name: Telegram notification
        if: always()
        run: |
          if [ -z "${{ secrets.TELEGRAM_TOKEN }}" ] || [ -z "${{ secrets.TELEGRAM_CHAT_ID }}" ]; then
            exit 0
          fi
          
          if [ "${{ steps.create_pr.outputs.merged }}" = "true" ]; then
            MESSAGE="‚úÖ TEST ‚Üí MAIN: MERGE EXITOSO%0A%0AüöÄ PR #${{ steps.create_pr.outputs.pr_number }} mergeado%0Aüì¶ C√≥digo promovido a producci√≥n%0Aüîó Iniciando deploy..."
          else
            MESSAGE="‚ö†Ô∏è TEST ‚Üí MAIN: PR CREADO%0A%0APR #${{ steps.create_pr.outputs.pr_number }}%0Aüîó ${{ steps.create_pr.outputs.pr_url }}%0A‚è≥ Esperando merge manual"
          fi
          
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d text="${MESSAGE}" || true

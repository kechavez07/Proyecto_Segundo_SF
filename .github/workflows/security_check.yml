name: security-check

on:
  push:
    branches:
      - dev  # Se ejecuta cuando hay push a dev

permissions:
  contents: write
  pull-requests: write
  issues: write
  
jobs:
  security-scan:
    name: security-check
    runs-on: ubuntu-latest
    outputs:
      vulnerable-found: ${{ steps.vuln_check.outputs.vuln }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Telegram notification - Inicio de revisi√≥n
        continue-on-error: true
        run: |
          if [ -z "${{ secrets.TELEGRAM_TOKEN }}" ] || [ -z "${{ secrets.TELEGRAM_CHAT_ID }}" ]; then
            echo "Telegram not configured"
            exit 0
          fi
          
          MESSAGE="üîç Etapa 1: INICIANDO REVISI√ìN DE SEGURIDAD%0A%0Aüìã Commit: ${GITHUB_SHA:0:7}%0Aüë§ Autor: @${{ github.actor }}%0Aüìù Mensaje: ${{ github.event.head_commit.message }}"
          
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d text="${MESSAGE}" || true

      - name: Get changed files in commit
        id: files
        run: |
          echo "Analyzing files in latest commit to dev"
          git fetch origin dev --depth=2
          CHANGED=$(git diff --name-only HEAD~1 HEAD || git ls-files || true)
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run vulnerability scanner
        id: scan
        run: |
          echo "Files to analyze:"
          echo "${{ steps.prep.outputs.files_to_scan }}"
          
          # Ejecutar scanner de vulnerabilidades (incluyendo archivos locales)
          if python git_scan_commits.py --commits 1 --local 2>&1 | tee scan.log; then
            echo "vulnerable=false" >> $GITHUB_OUTPUT
            echo "‚úì No vulnerabilities found"
          else
            echo "vulnerable=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Vulnerabilities detected"
          fi

      - name: Parse results
        id: parse
        if: always()
        run: |
          if [ -f result.json ]; then
            # Extraer informaci√≥n del resultado
            VULN_FOUND=$(jq -r '.summary.vulnerable_found' result.json)
            FILES_ANALYZED=$(jq -r '.summary.files_analyzed' result.json)
            
            echo "vuln_found=$VULN_FOUND" >> $GITHUB_OUTPUT
            echo "files_analyzed=$FILES_ANALYZED" >> $GITHUB_OUTPUT
            
            # Extraer archivos vulnerables
            VULN_FILES=$(jq -r '.commits[].files[] | select(.is_vulnerable==true) | "\(.file): \(.prediction) (\(.confidence)%)"' result.json || true)
            echo "vuln_files<<EOF" >> $GITHUB_OUTPUT
            echo "$VULN_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Upload results artifact
        id: art
        if: always() && hashFiles('result.json') != ''
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-result
          path: result.json
        continue-on-error: true

      - name: Set vulnerability output
        id: vuln_check
        run: |
          if [ -f result.json ]; then
            VULN=$(jq -r '.summary.vulnerable_found' result.json)
            echo "vuln=$VULN" >> $GITHUB_OUTPUT
          else
            echo "vuln=false" >> $GITHUB_OUTPUT
          fi

      - name: Telegram notification - Resultado clasificaci√≥n
        if: always()
        continue-on-error: true
        run: |
          if [ -z "${{ secrets.TELEGRAM_TOKEN }}" ] || [ -z "${{ secrets.TELEGRAM_CHAT_ID }}" ]; then
            echo "Telegram not configured"
            exit 0
          fi
          
          if [ -f result.json ]; then
            FILES=$(jq -r '.summary.files_analyzed' result.json)
            VULN=$(jq -r '.summary.vulnerable_found' result.json)
            
            if [ "$VULN" = "true" ]; then
              DETAILS=$(jq -r '.commits[].files[] | select(.is_vulnerable==true) | "- \(.file): \(.prediction) (probabilidad: \(.confidence)%)"' result.json | sed ':a;N;$!ba;s/\n/%0A/g')
              MESSAGE="‚ö†Ô∏è RESULTADO: C√ìDIGO VULNERABLE DETECTADO%0A%0Aüìä Archivos analizados: $FILES%0Aüö® Detalles:%0A$DETAILS%0A%0A‚ùå Commit rechazado - NO se crear√° PR"
            else
              MESSAGE="‚úÖ RESULTADO: C√ìDIGO SEGURO%0A%0Aüìä Archivos analizados: $FILES%0A‚úì No se detectaron vulnerabilidades%0A%0A‚û°Ô∏è Continuando con el pipeline..."
            fi
            
            curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="${MESSAGE}" || true
          fi

      - name: Create issue if vulnerabilities found
        uses: actions/github-script@v7
        if: steps.vuln_check.outputs.vuln == 'true'
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let result = null;
            if (fs.existsSync('result.json')) {
              result = JSON.parse(fs.readFileSync('result.json', 'utf8'));
            }
            
            if (!result) return;
            
            const vuln_files = result.commits
              .flatMap(c => c.files)
              .filter(f => f.is_vulnerable)
              .map(f => `- **${f.file}**: ${f.prediction} (confidence: ${f.confidence.toFixed(1)}%)`)
              .join("\n");
            
            const title = `üîí Security vulnerabilities detected in commit ${context.sha.substring(0, 7)}`;
            const issue_body = [
              `The automated security scanner detected vulnerabilities in the latest push to \`dev\` branch.`,
              "",
              `**Commit:** ${context.sha}`,
              `**Author:** @${context.actor}`,
              "",
              "**Flagged files:**",
              vuln_files,
              "",
              "‚ö†Ô∏è **Action Required:** Fix these vulnerabilities before the code can be promoted to test.",
            ].join("\n");
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body: issue_body,
              labels: ["security", "vulnerability", "urgent"]
            });

      - name: Telegram notification - Vulnerabilities Found
        if: steps.vuln_check.outputs.vuln == 'true'
        run: |
          if [ -z "${{ secrets.TELEGRAM_TOKEN }}" ] || [ -z "${{ secrets.TELEGRAM_CHAT_ID }}" ]; then
            echo "Telegram not configured"
            exit 0
          fi
          
          if [ -f result.json ]; then
            VULN_FILES=$(jq -r '.commits[].files[] | select(.is_vulnerable==true) | "\(.file): \(.prediction)"' result.json | sed ':a;N;$!ba;s/\n/%0A/g')
            MESSAGE="‚ö†Ô∏è Etapa 1: VULNERABILIDADES DETECTADAS%0A%0Aüîí Commit: ${{ github.sha }}%0AüìÅ Archivos:%0A${VULN_FILES}%0A%0A‚ùå El c√≥digo NO ser√° promovido hasta que se corrijan las vulnerabilidades."
            
            curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="${MESSAGE}" || true
          fi

  create-pr-to-test:
    name: Create PR to test
    runs-on: ubuntu-latest
    needs: [security-scan]
    if: needs.security-scan.outputs.vulnerable-found != 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Create Pull Request to test
        id: create_pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            
            // Verificar si ya existe un PR abierto de dev a test
            const { data: existingPRs } = await github.rest.pulls.list({
              owner,
              repo,
              state: 'open',
              head: `${owner}:dev`,
              base: 'test'
            });
            
            if (existingPRs.length > 0) {
              console.log(`‚úì PR already exists: #${existingPRs[0].number}`);
              core.setOutput('pr_number', existingPRs[0].number);
              core.setOutput('pr_url', existingPRs[0].html_url);
              return;
            }
            
            // Crear nuevo PR
            const { data: pr } = await github.rest.pulls.create({
              owner,
              repo,
              title: 'üîí Security Check Passed - Ready for Testing',
              head: 'dev',
              base: 'test',
              body: [
                '## ‚úÖ Security Scan Passed',
                '',
                'All security checks have passed successfully.',
                '',
                '**Next Steps:**',
                '- Automated tests will run on this PR',
                '- If tests pass, it will be automatically merged to `test`',
                '- Then it will be promoted to `main`',
                '',
                `**Commit:** ${context.sha}`,
                `**Author:** @${context.actor}`
              ].join('\n')
            });
            
            console.log(`‚úì Created PR #${pr.number}: ${pr.html_url}`);
            core.setOutput('pr_number', pr.number);
            core.setOutput('pr_url', pr.html_url);
            
      - name: Telegram notification - PR Created
        run: |
          if [ -z "${{ secrets.TELEGRAM_TOKEN }}" ] || [ -z "${{ secrets.TELEGRAM_CHAT_ID }}" ]; then
            echo "Telegram not configured"
            exit 0
          fi
          
          MESSAGE="‚úÖ Etapa 1: ESCANEO DE SEGURIDAD EXITOSO%0A%0A‚úì C√≥digo seguro verificado%0Aüìù PR creado autom√°ticamente: dev ‚Üí test%0APR #${{ steps.create_pr.outputs.pr_number }}%0Aüîó ${{ steps.create_pr.outputs.pr_url }}%0A%0A‚û°Ô∏è Ejecutando pruebas autom√°ticas..."
          
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d text="${MESSAGE}" || true
